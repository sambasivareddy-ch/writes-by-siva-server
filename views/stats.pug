html(lang="en")
    head
        meta(charset="UTF-8")
        meta(name="viewport", content="width=device-width, initial-scale=1.0")
        title Stats
        link(rel="stylesheet", href="/css/index.css")
        script(src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js")
        style. 
            canvas {
                max-width: 800px;
                margin: 30px auto;
                display: block;
            }
    body 
        include layout.pug 
        .stats_wrapper 
            h2 BySiva.blog Stats
            .stats
                .stats_main 
                    h2 Newsletter Subscribers Stats 
                    canvas#statsChart2
                .stats_main 
                    h2 Blog Stats 
                    canvas#statsChart
                .stats_main 
                    h2 Cumulative Reactions
                    canvas#statsChart1
        script.
            const labels = !{labels};
            const views = !{views};
            const reactions = !{reactions};
            const cumulative = !{cumulative};
            const subMonthLabels = !{subMonthLabels};
            const subMonthly = !{subsMonthly};

            const ctx = document.getElementById('statsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Views',
                            data: views,
                            backgroundColor: '#81d4fa'
                        },
                        {
                            label: 'Reactions',
                            data: reactions,
                            backgroundColor: '#80deea'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Blog Engagement'
                        }
                    }
                }
            });

            const ctx1 = document.getElementById('statsChart1').getContext('2d');

            new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Likes', 'Fires', 'Laughs', 'Anger'],
                datasets: [
                    {
                        label: 'Engagements',
                        data: cumulative,
                        backgroundColor: [
                            '#d1c4e9',
                            '#c5cae9',
                            '#bbdefb',
                            '#b2dfdb'
                        ],
                        hoverOffset: 8,
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: {
                title: {
                    display: true,
                    text: 'Monthly Blog Engagement',
                    font: {
                    size: 18,
                    },
                },
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                    label: function (context) {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        const total = context.chart._metasets[0].total;
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value} (${percentage}%)`;
                    },
                    },
                },
                },
            },
            });

            const ctx2 = document.getElementById('statsChart2').getContext('2d');
            new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: subMonthLabels,
                    datasets: [
                        {
                            label: 'New Subscribers (per month)',
                            data: subMonthly,
                            fill: true,          // fills area under the line
                            tension: 0.25,       // smoothing
                            borderWidth: 2,
                            pointRadius: 4,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.12)',
                        },
                    ]
                },
                options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                    display: true,
                    text: 'Monthly New Subscribers'
                    },
                    tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: (ctx) => {
                        const v = ctx.raw ?? 0;
                        return `${ctx.dataset.label}: ${v}`;
                        }
                    }
                    },
                    legend: {
                    position: 'bottom'
                    }
                },
                interaction: {
                    mode: 'nearest',
                    intersect: false
                },
                scales: {
                    x: {
                    title: { display: true, text: 'Month' },
                    ticks: {
                        // rotate if many months
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 12
                    }
                    },
                    y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Subscribers' },
                    ticks: {
                        precision: 0 // integer ticks
                    }
                    }
                }
                }
            });